From 9ace0bd6000c7080030591835d0ee194d16caa7d Mon Sep 17 00:00:00 2001
From: Thomas Nizan <tnizan@witekio.com>
Date: Tue, 20 Apr 2021 10:57:14 -0700
Subject: [PATCH 14/15] xilinx-vipp: debug + blacklist

---
 drivers/media/platform/xilinx/xilinx-vipp.c | 19 ++++++++++++++++++-
 1 file changed, 18 insertions(+), 1 deletion(-)

diff --git a/drivers/media/platform/xilinx/xilinx-vipp.c b/drivers/media/platform/xilinx/xilinx-vipp.c
index ccaa9438f45c..741b384e0e6b 100644
--- a/drivers/media/platform/xilinx/xilinx-vipp.c
+++ b/drivers/media/platform/xilinx/xilinx-vipp.c
@@ -8,6 +8,7 @@
  * Contacts: Hyun Kwon <hyun.kwon@xilinx.com>
  *           Laurent Pinchart <laurent.pinchart@ideasonboard.com>
  */
+#define DEBUG
 
 #include <linux/list.h>
 #include <linux/module.h>
@@ -564,7 +565,8 @@ static int xvip_graph_parse_one(struct xvip_composite_device *xdev,
 {
 	struct fwnode_handle *remote;
 	struct fwnode_handle *ep = NULL;
-	int ret = 0;
+	int ret = 0;	
+	const char *drivers[10];
 
 	dev_dbg(xdev->dev, "parsing node %p\n", fwnode);
 
@@ -582,6 +584,7 @@ static int xvip_graph_parse_one(struct xvip_composite_device *xdev,
 			ret = -EINVAL;
 			goto err_notifier_cleanup;
 		}
+		dev_dbg(xdev->dev, " handling remote %p\n", remote);
 
 		fwnode_handle_put(ep);
 
@@ -589,9 +592,23 @@ static int xvip_graph_parse_one(struct xvip_composite_device *xdev,
 		if (remote == of_fwnode_handle(xdev->dev->of_node) ||
 		    xvip_graph_find_entity(xdev, remote)) {
 			fwnode_handle_put(remote);
+			dev_dbg(xdev->dev, " remote already processed\n");
 			continue;
 		}
 
+		/* Skip blacklisted entities.*/
+		ret = fwnode_property_read_string_array(remote, "compatible",
+						drivers, 10);
+		if (ret > 0)
+		{
+			dev_dbg(xdev->dev, " ret %d    compatible %s\n", ret, drivers[0]);
+			if (!strcmp(drivers[0], "onnn,mars"))
+			{
+				dev_dbg(xdev->dev, "   skipping mars driver\n");
+				continue;
+			}
+		}
+
 		asd = v4l2_async_notifier_add_fwnode_subdev(
 			&xdev->notifier, remote,
 			sizeof(struct xvip_graph_entity));
-- 
2.20.1

